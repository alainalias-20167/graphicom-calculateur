<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Graphicom — Calculateur Prix de Revient & Vente (HT)</title>
  <style>
    :root { --b:#111; --g:#666; --bg:#f6f7f9; --w:#fff; --bd:#e5e7eb; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:var(--b);}
    header{padding:18px 16px; background:var(--w); border-bottom:1px solid var(--bd);}
    h1{margin:0; font-size:18px;}
    main{max-width:1200px; margin:0 auto; padding:16px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media(min-width:980px){ .grid{grid-template-columns: 1.15fr .85fr;} }
    .card{background:var(--w); border:1px solid var(--bd); border-radius:12px; padding:14px;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:end;}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; align-items:end;}
    .row4{display:grid; grid-template-columns: 1.2fr .8fr .8fr .8fr; gap:10px; align-items:end;}
    .row.head{font-weight:600; color:var(--g); font-size:12px; text-transform:uppercase;}
    label{display:block; font-size:12px; color:var(--g); margin-bottom:6px;}
    input, select, button, textarea{
      width:100%; padding:10px; border:1px solid var(--bd); border-radius:10px; background:#fff;
      font-size:14px; box-sizing:border-box;
    }
    input[type="number"]{text-align:right;}
    .btns{display:flex; gap:10px; flex-wrap:wrap;}
    button{cursor:pointer; font-weight:600;}
    button.primary{background:#111; color:#fff; border-color:#111;}
    button.ghost{background:#fff;}
    .muted{color:var(--g); font-size:12px;}
    .totals{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .kpi{border:1px solid var(--bd); border-radius:12px; padding:12px;}
    .kpi .t{color:var(--g); font-size:12px;}
    .kpi .v{font-size:18px; font-weight:700; margin-top:6px;}
    .kpi .s{font-size:12px; color:var(--g); margin-top:4px;}
    .hr{height:1px; background:var(--bd); margin:12px 0;}
    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{border-bottom:1px solid var(--bd); padding:8px; text-align:left;}
    td.num{text-align:right;}
    .pill{display:inline-block; padding:4px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; color:var(--g);}
    .pillBox{border:1px solid var(--bd); border-radius:12px; padding:10px; min-width:170px;}
    .chk{display:flex; align-items:center; gap:10px;}
    .chk input{width:auto;}
    .warn{background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; border-radius:10px; padding:10px; font-size:12px;}
    .ok{background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; border-radius:10px; padding:10px; font-size:12px;}
  </style>
</head>
<body>
<header>
  <h1>Graphicom — Calculateur Prix de Revient & Prix de Vente (HT)</h1>
  <div class="muted">Appli locale (navigateur). Données enregistrées sur cet appareil.</div>
</header>

<main class="grid">
  <!-- COL 1 -->
  <section class="card">

    <div class="row3">
      <div>
        <label>Famille</label>
        <select id="family"></select>
        <div class="muted" style="margin-top:6px;">Organigramme : Famille → Produit (préréglage).</div>
      </div>
      <div style="grid-column: span 2;">
        <label>Produit (préréglage)</label>
        <select id="preset"></select>
        <div class="muted" style="margin-top:6px;">Le produit remplit la composition + options. Tu peux ensuite ajuster.</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row4">
      <div>
        <label>Nom du produit / chantier</label>
        <input id="productName" placeholder="Ex : Enseigne panneau 1200×800 + pose nacelle" />
      </div>
      <div>
        <label>Largeur L (m)</label>
        <input id="L" type="number" min="0" step="0.001" value="1" />
      </div>
      <div>
        <label>Hauteur H (m)</label>
        <input id="H" type="number" min="0" step="0.001" value="1" />
      </div>
      <div>
        <label>Quantité</label>
        <input id="qty" type="number" min="0" step="0.01" value="1" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Profondeur P (m) (uniquement bandeau caisson)</label>
        <input id="P" type="number" min="0" step="0.001" value="0.20" />
        <div class="muted">Utilisée pour calculer la surface développée (face + retours).</div>
      </div>
      <div>
        <label>Heures CNC / m² (si découpe CNC)</label>
        <input id="cncHperM2" type="number" min="0" step="0.01" value="0.20" />
        <div class="muted">Estimation modifiable. On pourra la verrouiller par produit ensuite.</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row" style="align-items:start;">
      <!-- Options -->
      <div class="card" style="padding:12px;">
        <div class="pill">Options</div>

        <div class="hr"></div>

        <div class="chk">
          <input id="infog_on" type="checkbox" />
          <label style="margin:0;">Inclure infographie</label>
        </div>
        <div class="row" style="margin-top:8px;">
          <div>
            <label>Heures infographie</label>
            <input id="infog_h" type="number" min="0" step="0.05" value="0" />
          </div>
          <div>
            <label>Taux infographie (€/h)</label>
            <input id="infog_rate" type="number" min="0" step="0.01" value="80" />
          </div>
        </div>

        <div class="hr"></div>

        <label>Mode de pose</label>
        <select id="poseMode"></select>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>Heures pose</label>
            <input id="pose_h" type="number" min="0" step="0.05" value="0" />
          </div>
          <div>
            <label>Taux pose (€/h)</label>
            <input id="pose_rate" type="number" min="0" step="0.01" value="70" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>Déplacement (forfait €)</label>
            <input id="depl_forfait" type="number" min="0" step="0.01" value="0" />
          </div>
          <div>
            <label>Nacelle (jours)</label>
            <input id="nacelle_j" type="number" min="0" step="0.1" value="0" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>PU nacelle (€/jour)</label>
            <input id="nacelle_pu" type="number" min="0" step="0.01" value="0" />
          </div>
          <div>
            <label>Poteaux (nb)</label>
            <input id="poteaux_nb" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>PU poteau (€/u)</label>
            <input id="poteau_pu" type="number" min="0" step="0.01" value="0" />
          </div>
          <div>
            <label>Plots béton (nb)</label>
            <input id="plots_nb" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>PU plot (€/u)</label>
            <input id="plot_pu" type="number" min="0" step="0.01" value="0" />
          </div>
          <div>
            <label>Scellement / terrassement (h)</label>
            <input id="scellement_h" type="number" min="0" step="0.05" value="0" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="warn">
          “Entretoises” et “Structure drapeau” n’ont pas de PU dans ta liste : ils restent à 0 par défaut (modifiables).
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>PU Entretoises (€/u)</label>
            <input id="entretoise_pu" type="number" min="0" step="0.01" value="0" />
          </div>
          <div>
            <label>PU Structure drapeau (forfait €)</label>
            <input id="structure_pu" type="number" min="0" step="0.01" value="0" />
          </div>
        </div>
      </div>

      <!-- Réglages atelier / structure -->
      <div class="card" style="padding:12px;">
        <div class="pill">Réglages atelier / structure</div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label>Taux atelier (€/h)</label>
            <input id="atelier_rate" type="number" min="0" step="0.01" value="60" />
          </div>
          <div>
            <label>Majoration &lt; 1 m² (%)</label>
            <input id="small_markup" type="number" min="0" step="0.1" value="10" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>Frais fixes / structure (% sur directs)</label>
            <input id="overheadPct" type="number" min="0" step="0.1" value="15" />
          </div>
          <div>
            <label>Frais fixes (forfait €)</label>
            <input id="overheadFlat" type="number" min="0" step="0.01" value="0" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="pill">Objectif de vente</div>
        <div class="row" style="margin-top:8px;">
          <div>
            <label>Marge (%)</label>
            <input id="marginPct" type="number" min="0" step="0.1" value="40" />
          </div>
          <div>
            <label>ou Coefficient (optionnel)</label>
            <input id="coef" type="number" min="0" step="0.01" value="" placeholder="ex : 2.10" />
          </div>
        </div>
        <div class="muted">Si coefficient renseigné, il prime sur la marge.</div>

        <div class="hr"></div>

        <label>Notes</label>
        <textarea id="notes" rows="6" placeholder="Contraintes, références matières, etc."></textarea>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Composition / Sandwich -->
    <div class="card" style="padding:12px;">
      <div class="pill">Composition (sandwich)</div>
      <div id="comp_list" style="font-size:13px; line-height:1.45; margin-top:10px;"></div>

      <div style="display:flex; gap:12px; margin-top:10px; flex-wrap:wrap;">
        <div class="pillBox">
          <div style="font-size:12px; opacity:.75;">Sandwich (€/m²)</div>
          <div id="comp_sandwich_m2" style="font-size:18px; font-weight:700;">0,00 €</div>
        </div>
        <div class="pillBox">
          <div style="font-size:12px; opacity:.75;">Sandwich total (surface)</div>
          <div id="comp_sandwich_total" style="font-size:18px; font-weight:700;">0,00 €</div>
        </div>
        <div class="pillBox">
          <div style="font-size:12px; opacity:.75;">Surface unitaire</div>
          <div id="comp_surface_u" style="font-size:18px; font-weight:700;">0,00 m²</div>
        </div>
      </div>

      <div class="muted" style="margin-top:8px;">
        Le “sandwich” additionne uniquement les composants matières au m² (hors atelier, CNC, pose, infographie, déplacement, nacelle…).
      </div>
    </div>

    <div class="hr"></div>

    <!-- Lignes calculées -->
    <div class="row head">
      <div>Ligne de coût</div><div>Qté</div><div>PU (€)</div><div>Total</div>
    </div>
    <div id="lines"></div>

    <div class="btns" style="margin-top:12px;">
      <button class="ghost" id="save">Enregistrer</button>
      <button class="ghost" id="load">Charger</button>
      <button class="ghost" id="exportCsv">Exporter CSV</button>
      <button class="primary" id="reset">Réinitialiser</button>
    </div>

    <div class="muted" style="margin-top:10px;">
      Astuce : on peut ensuite ajouter “LED”, “Alim”, “Rails”, etc. dans la famille enseigne (bandeau/caisson), mais on verrouille d’abord la logique composition → lignes.
    </div>
  </section>

  <!-- COL 2 -->
  <aside class="card">
    <h2 style="margin:0 0 10px 0; font-size:16px;">Résultats</h2>

    <div class="totals">
      <div class="kpi">
        <div class="t">Coûts matières & options</div>
        <div class="v" id="k_mat">0,00 €</div>
        <div class="s">Somme des lignes</div>
      </div>
      <div class="kpi">
        <div class="t">Atelier</div>
        <div class="v" id="k_atelier">0,00 €</div>
        <div class="s"><span id="k_ah">0</span> h × <span id="k_ar">0</span> €/h</div>
      </div>
      <div class="kpi">
        <div class="t">Pose + options pose</div>
        <div class="v" id="k_pose">0,00 €</div>
        <div class="s">HT</div>
      </div>
      <div class="kpi">
        <div class="t">Frais fixes / structure</div>
        <div class="v" id="k_ovh">0,00 €</div>
        <div class="s"><span id="k_ovhp">0</span>% + forfait</div>
      </div>
      <div class="kpi">
        <div class="t">Prix de revient (total)</div>
        <div class="v" id="k_cost">0,00 €</div>
        <div class="s">Pour la quantité</div>
      </div>
      <div class="kpi">
        <div class="t">Prix de vente HT</div>
        <div class="v" id="k_sell_ht">0,00 €</div>
        <div class="s"><span id="k_margin_used">marge</span></div>
      </div>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 10px 0; font-size:14px;">Détail unitaire</h3>
    <table>
      <tbody>
        <tr><td>Prix de revient / unité</td><td class="num" id="u_cost">0,00 €</td></tr>
        <tr><td>Vente HT / unité</td><td class="num" id="u_sell_ht">0,00 €</td></tr>
      </tbody>
    </table>

    <div class="hr"></div>

    <div class="ok">
      Si tu modifies une PU dans les champs options (nacelle, poteau, plot, structure…), le calcul se met à jour immédiatement.
    </div>
  </aside>
</main>

<script>
/** =====================
 *  FORMAT / HELPERS
 *  ===================== */
const fmt = (n) => (Number(n || 0)).toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';
const fmtM2 = (n) => (Number(n || 0)).toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' m²';
const byId = (id) => document.getElementById(id);
const esc = (s) => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

/** =====================
 *  DONNÉES (PU) — issues de ta liste
 *  ===================== */
const PU = {
  dibond_3_m2: 17.20,
  vinyl_poly_m2: 3.80,
  encre_vinyl_m2: 4.00,
  lam_poly_mat_m2: 3.63,
  vinyl_dao_3m_m2: 6.13,
  tape_papier_m2: 1.30,
  tape_transp_m2: 1.52,
  atelier_10mn_m2: 5.00,       // “Atelier impression (10mn/m2) : 5”
  cnc_h: 17.60                 // “Découpe cnc : 17,60”
};

/** =====================
 *  RÈGLES
 *  ===================== */
const RULES = {
  smallAreaThreshold_m2: 1.0
};

/** =====================
 *  FAMILLES / PRODUITS (ENSEIGNE)
 *  Organigramme fourni par toi
 *  ===================== */
const FAMILIES = {
  enseigne: {
    key: "enseigne",
    label: "Enseigne",
    products: [
      { key:"ens_panneau_quadri", label:"Enseigne — panneau QUADRI (dibond + vinyl polymère + encre + lamination)", type:"flat_quadri" },
      { key:"ens_panneau_dao",    label:"Enseigne — panneau vinyl DAO (dibond + vinyl DAO + tape)", type:"flat_dao" },

      { key:"ens_forme_quadri",   label:"Enseigne — panneau à forme QUADRI (+ découpe CNC)", type:"shape_quadri" },
      { key:"ens_forme_dao",      label:"Enseigne — panneau à forme vinyl DAO (+ découpe CNC)", type:"shape_dao" },

      { key:"ens_caisson_quadri", label:"Enseigne — bandeau caisson QUADRI (L×H×P) (+ découpe CNC)", type:"box_quadri" },
      { key:"ens_caisson_dao",    label:"Enseigne — bandeau caisson vinyl DAO (L×H×P) (+ découpe CNC)", type:"box_dao" },

      { key:"ens_lettres",        label:"Enseigne — lettres découpées (dibond + découpe CNC + entretoises)", type:"letters" },

      { key:"ens_drapeau_quadri", label:"Enseigne — drapeau QUADRI (dibond + quadri + lamination + découpe CNC + structure)", type:"flag_quadri" },
      { key:"ens_drapeau_dao",    label:"Enseigne — drapeau vinyl DAO (dibond + DAO + tape + découpe CNC + structure)", type:"flag_dao" },
    ]
  }
};

/** =====================
 *  MODES DE POSE
 *  ===================== */
const POSE_MODES = {
  SANS_POSE: { key:"SANS_POSE", label:"Sans pose" },
  MUR_ECHELLE: { key:"MUR_ECHELLE", label:"Pose murale (échelle)" },
  MUR_NACELLE: { key:"MUR_NACELLE", label:"Pose murale (nacelle)" },
  POTEAUX_PLOTS: { key:"POTEAUX_PLOTS", label:"Poteaux + plots béton" },
  STRUCTURE_EXISTANTE: { key:"STRUCTURE_EXISTANTE", label:"Sur structure existante" },
};

/** =====================
 *  STATE
 *  ===================== */
const defaultState = () => ({
  familyKey: "enseigne",
  productKey: "ens_panneau_quadri",
  productName: "",
  L: 1,
  H: 1,
  P: 0.20,
  qty: 1,

  // options
  infog_on: false,
  infog_h: 0,
  infog_rate: 80,

  poseMode: "SANS_POSE",
  pose_h: 0,
  pose_rate: 70,
  deplacement_forfait: 0,
  nacelle_j: 0,
  nacelle_pu: 0,
  poteaux_nb: 0,
  poteau_pu: 0,
  plots_nb: 0,
  plot_pu: 0,
  scellement_h: 0,

  entretoise_pu: 0,
  structure_pu: 0,

  // atelier/structure
  atelier_rate: 60,
  cncHperM2: 0.20,
  small_markup_pct: 10,
  overheadPct: 15,
  overheadFlat: 0,

  // vente
  marginPct: 40,
  coef: "",
  notes: "",

  // calcul
  lines: []
});

let state = defaultState();

/** =====================
 *  UI BIND
 *  ===================== */
function fillFamilySelect(){
  const sel = byId("family");
  sel.innerHTML = "";
  Object.values(FAMILIES).forEach(f=>{
    const opt = document.createElement("option");
    opt.value = f.key;
    opt.textContent = f.label;
    sel.appendChild(opt);
  });
  sel.value = state.familyKey;
}

function fillProductSelect(){
  const fam = FAMILIES[state.familyKey];
  const sel = byId("preset");
  sel.innerHTML = "";
  fam.products.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.key;
    opt.textContent = p.label;
    sel.appendChild(opt);
  });
  sel.value = state.productKey;
}

function fillPoseModes(){
  const sel = byId("poseMode");
  sel.innerHTML = "";
  Object.values(POSE_MODES).forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m.key;
    opt.textContent = m.label;
    sel.appendChild(opt);
  });
  sel.value = state.poseMode;
}

function bindInputs(){
  const map = [
    ["productName","productName","text"],
    ["L","L","num"],["H","H","num"],["P","P","num"],["qty","qty","num"],
    ["cncHperM2","cncHperM2","num"],
    ["infog_h","infog_h","num"],["infog_rate","infog_rate","num"],
    ["pose_h","pose_h","num"],["pose_rate","pose_rate","num"],
    ["depl_forfait","deplacement_forfait","num"],
    ["nacelle_j","nacelle_j","num"],["nacelle_pu","nacelle_pu","num"],
    ["poteaux_nb","poteaux_nb","num"],["poteau_pu","poteau_pu","num"],
    ["plots_nb","plots_nb","num"],["plot_pu","plot_pu","num"],
    ["scellement_h","scellement_h","num"],
    ["entretoise_pu","entretoise_pu","num"],
    ["structure_pu","structure_pu","num"],
    ["atelier_rate","atelier_rate","num"],
    ["small_markup","small_markup_pct","num"],
    ["overheadPct","overheadPct","num"],["overheadFlat","overheadFlat","num"],
    ["marginPct","marginPct","num"],["coef","coef","text"],
    ["notes","notes","text"],
  ];

  map.forEach(([id,k,typ])=>{
    const el = byId(id);
    if(!el) return;
    const setVal = ()=>{
      if(typ==="num") state[k]=Number(el.value||0);
      else state[k]=el.value;
      recalc();
    };
    el.addEventListener("input", setVal);
  });

  byId("infog_on").addEventListener("change", (e)=>{
    state.infog_on = !!e.target.checked;
    recalc();
  });

  byId("family").addEventListener("change", (e)=>{
    state.familyKey = e.target.value;
    // pick first product of family
    const fam = FAMILIES[state.familyKey];
    state.productKey = fam.products[0].key;
    fillProductSelect();
    syncProductNameDefault();
    recalc();
  });

  byId("preset").addEventListener("change", (e)=>{
    state.productKey = e.target.value;
    syncProductNameDefault();
    recalc();
  });

  byId("poseMode").addEventListener("change", (e)=>{
    state.poseMode = e.target.value;
    recalc();
  });
}

function syncProductNameDefault(){
  const fam = FAMILIES[state.familyKey];
  const p = fam.products.find(x=>x.key===state.productKey);
  if(!state.productName) {
    state.productName = p ? p.label.split("(")[0].trim() : "";
    byId("productName").value = state.productName;
  }
}

/** =====================
 *  COMPOSITION / LIGNES
 *  ===================== */
function surfaceUnit(){
  const L = Number(state.L||0);
  const H = Number(state.H||0);
  return L*H;
}
function surfaceTot(){
  return surfaceUnit() * Number(state.qty||0);
}

// surface développée d'un bandeau caisson : face + retours
function surfaceBoxDevelopedPerUnit(){
  const L = Number(state.L||0);
  const H = Number(state.H||0);
  const P = Number(state.P||0);
  const face = L*H;
  const retours = 2*(L*P) + 2*(H*P);
  return face + retours;
}

/**
 * Retourne un objet "composition" (matières) selon le type produit.
 * (On sépare matières au m² des opérations au temps / forfait)
 */
function getProductDef(){
  const fam = FAMILIES[state.familyKey];
  return fam.products.find(p=>p.key===state.productKey);
}

function buildLines(){
  const p = getProductDef();
  const qty = Number(state.qty||0);
  const sU = surfaceUnit();
  const sT = surfaceTot();

  const lines = [];

  // --- matières m²
  function addMat(label, q, pu){
    if(!q || q===0) return;
    lines.push({label, qty:q, pu, group:"MAT"});
  }

  // --- opérations (atelier/CNC/forfait)
  function addOp(label, q, pu, group){
    if(!q || q===0) return;
    lines.push({label, qty:q, pu, group:group||"OP"});
  }

  // Règle majoration <1m² : uniquement sur matières au m²
  const markupRate = (sU < RULES.smallAreaThreshold_m2) ? (Number(state.small_markup_pct||0)/100) : 0;

  // Helper : applique majoration sur une ligne MAT
  function applyMarkupOnLastMat(){
    if(markupRate<=0) return;
    const last = lines[lines.length-1];
    if(!last || last.group!=="MAT") return;
    last.pu = last.pu * (1 + markupRate);
  }

  // ===== Composition par type (organigramme)
  switch(p.type){
    case "flat_quadri":
      addMat("Dibond 3 mm", sT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addMat("Vinyl polymère", sT, PU.vinyl_poly_m2); applyMarkupOnLastMat();
      addMat("Encre pour vinyl", sT, PU.encre_vinyl_m2); applyMarkupOnLastMat();
      addMat("Lamination polymère mat", sT, PU.lam_poly_mat_m2); applyMarkupOnLastMat();
      break;

    case "flat_dao":
      addMat("Dibond 3 mm", sT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addMat("Vinyl DAO 3M", sT, PU.vinyl_dao_3m_m2); applyMarkupOnLastMat();
      addMat("Tape papier", sT, PU.tape_papier_m2); applyMarkupOnLastMat();
      break;

    case "shape_quadri":
      addMat("Dibond 3 mm", sT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addMat("Vinyl polymère", sT, PU.vinyl_poly_m2); applyMarkupOnLastMat();
      addMat("Encre pour vinyl", sT, PU.encre_vinyl_m2); applyMarkupOnLastMat();
      addMat("Lamination polymère mat", sT, PU.lam_poly_mat_m2); applyMarkupOnLastMat();
      // CNC en heures
      addOp("Découpe CNC", sU * qty * Number(state.cncHperM2||0), PU.cnc_h, "CNC");
      break;

    case "shape_dao":
      addMat("Dibond 3 mm", sT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addMat("Vinyl DAO 3M", sT, PU.vinyl_dao_3m_m2); applyMarkupOnLastMat();
      addMat("Tape papier", sT, PU.tape_papier_m2); applyMarkupOnLastMat();
      addOp("Découpe CNC", sU * qty * Number(state.cncHperM2||0), PU.cnc_h, "CNC");
      break;

    case "box_quadri": {
      const devU = surfaceBoxDevelopedPerUnit();
      const devT = devU * qty;
      addMat("Dibond (face + retours)", devT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addMat("Vinyl polymère", (sU*qty), PU.vinyl_poly_m2); applyMarkupOnLastMat(); // habillage face
      addMat("Encre pour vinyl", (sU*qty), PU.encre_vinyl_m2); applyMarkupOnLastMat();
      addMat("Lamination polymère mat", (sU*qty), PU.lam_poly_mat_m2); applyMarkupOnLastMat();
      addOp("Découpe CNC", devU * qty * Number(state.cncHperM2||0), PU.cnc_h, "CNC");
      break;
    }

    case "box_dao": {
      const devU = surfaceBoxDevelopedPerUnit();
      const devT = devU * qty;
      addMat("Dibond (face + retours)", devT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addMat("Vinyl DAO 3M", (sU*qty), PU.vinyl_dao_3m_m2); applyMarkupOnLastMat();
      addMat("Tape papier", (sU*qty), PU.tape_papier_m2); applyMarkupOnLastMat();
      addOp("Découpe CNC", devU * qty * Number(state.cncHperM2||0), PU.cnc_h, "CNC");
      break;
    }

    case "letters":
      // Lettres : on reste simple : base = surface (à affiner plus tard par gabarit réel)
      addMat("Dibond 3 mm", sT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addOp("Découpe CNC", sU * qty * Number(state.cncHperM2||0), PU.cnc_h, "CNC");
      addOp("Entretoises", qty, Number(state.entretoise_pu||0), "FORFAIT");
      break;

    case "flag_quadri":
      addMat("Dibond 3 mm", sT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addMat("Vinyl polymère", sT, PU.vinyl_poly_m2); applyMarkupOnLastMat();
      addMat("Encre pour vinyl", sT, PU.encre_vinyl_m2); applyMarkupOnLastMat();
      addMat("Lamination polymère mat", sT, PU.lam_poly_mat_m2); applyMarkupOnLastMat();
      addOp("Découpe CNC", sU * qty * Number(state.cncHperM2||0), PU.cnc_h, "CNC");
      addOp("Structure drapeau (forfait)", 1, Number(state.structure_pu||0), "FORFAIT");
      break;

    case "flag_dao":
      addMat("Dibond 3 mm", sT, PU.dibond_3_m2); applyMarkupOnLastMat();
      addMat("Vinyl DAO 3M", sT, PU.vinyl_dao_3m_m2); applyMarkupOnLastMat();
      addMat("Tape papier", sT, PU.tape_papier_m2); applyMarkupOnLastMat();
      addOp("Découpe CNC", sU * qty * Number(state.cncHperM2||0), PU.cnc_h, "CNC");
      addOp("Structure drapeau (forfait)", 1, Number(state.structure_pu||0), "FORFAIT");
      break;

    default:
      break;
  }

  // Atelier (temps) : on l’exprime en heures via un “atelier_h_per_m2” interne simple.
  // Pour l’instant, on prend la base “10mn/m²” => 0.1667 h/m².
  // Si tu veux par produit (0.25h/m² etc.), on le mettra ensuite.
  const atelier_h = (sU * qty) * (10/60);
  addOp("Atelier (temps)", atelier_h, Number(state.atelier_rate||0), "ATELIER");

  // Infographie si activée
  if(state.infog_on){
    addOp("Infographie", Number(state.infog_h||0), Number(state.infog_rate||0), "INFO");
  }

  // Pose
  let poseTotal = 0;
  if(state.poseMode !== "SANS_POSE"){
    addOp("Pose", Number(state.pose_h||0), Number(state.pose_rate||0), "POSE");
    addOp("Déplacement (forfait)", 1, Number(state.deplacement_forfait||0), "POSE");
    if(state.poseMode === "MUR_NACELLE"){
      addOp("Nacelle", Number(state.nacelle_j||0), Number(state.nacelle_pu||0), "POSE");
    }
    if(state.poseMode === "POTEAUX_PLOTS"){
      addOp("Poteaux", Number(state.poteaux_nb||0), Number(state.poteau_pu||0), "POSE");
      addOp("Plots béton", Number(state.plots_nb||0), Number(state.plot_pu||0), "POSE");
      addOp("Scellement / terrassement", Number(state.scellement_h||0), Number(state.pose_rate||0), "POSE");
    }
  }

  // Totaux ligne
  lines.forEach(ln => ln.total = Number(ln.qty||0) * Number(ln.pu||0));
  return lines;
}

/** =====================
 *  RENDER LINES + COMPOSITION
 *  ===================== */
function renderLines(){
  const container = byId("lines");
  container.innerHTML = "";
  state.lines.forEach((ln)=>{
    const row = document.createElement("div");
    row.className = "row4";
    row.innerHTML = `
      <div><input value="${esc(ln.label)}" disabled /></div>
      <div><input value="${(Number(ln.qty||0)).toLocaleString('fr-FR',{maximumFractionDigits:4})}" disabled /></div>
      <div><input value="${(Number(ln.pu||0)).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})}" disabled /></div>
      <div><input value="${fmt(ln.total)}" disabled /></div>
    `;
    container.appendChild(row);
  });
}

function renderComposition(){
  const listEl = byId("comp_list");
  const m2El   = byId("comp_sandwich_m2");
  const totEl  = byId("comp_sandwich_total");
  const suEl   = byId("comp_surface_u");

  const qty = Number(state.qty||0);
  const sU = surfaceUnit();
  const sT = surfaceTot();

  suEl.textContent = fmtM2(sU);

  // Sandwich = seulement lignes MAT au m² (PU au m²)
  const matLines = state.lines.filter(l => l.group === "MAT");
  let sandwich_m2 = 0;

  // On calcule un €/m² à partir de la somme des pu des matières (puisqu’on applique déjà la majoration sur PU)
  // Attention : on veut un sandwich standard “par m² de face” (donc basé sur sT = L*H*qty).
  // Pour les caissons, on affichera quand même le sandwich “face” (vinyl/encre/lam sur face) + dibond dev dans la liste.
  // On fait donc : (somme total matières) / surfaceTot (face) si surfaceTot>0
  const totalMat = matLines.reduce((s,l)=>s + l.total, 0);
  sandwich_m2 = (sT>0) ? (totalMat / sT) : 0;

  if(matLines.length===0){
    listEl.innerHTML = "<div class='muted'>Aucune matière détectée.</div>";
  }else{
    listEl.innerHTML = matLines.map(l=>`
      <div style="display:flex; justify-content:space-between; gap:12px; padding:4px 0; border-bottom:1px solid rgba(0,0,0,.06);">
        <div>${esc(l.label)}</div>
        <div style="font-weight:600;">${fmt(l.total)}</div>
      </div>
    `).join("");
  }

  m2El.textContent = fmt(sandwich_m2);
  totEl.textContent = fmt(sandwich_m2 * sT);
}

/** =====================
 *  CALC + KPI
 *  ===================== */
function recalc(){
  // rebuild lines
  state.lines = buildLines();

  // totals
  const mat = state.lines.reduce((s,l)=>s + (l.total||0), 0);

  const atelier = state.lines.filter(l=>l.group==="ATELIER").reduce((s,l)=>s+(l.total||0),0);
  const pose = state.lines.filter(l=>l.group==="POSE").reduce((s,l)=>s+(l.total||0),0);

  const direct = mat; // tout est déjà dans lignes
  const ovh = direct*(Number(state.overheadPct||0)/100) + Number(state.overheadFlat||0);
  const cost = direct + ovh;

  const coef = Number(state.coef||0);
  const useCoef = coef>0;
  const marginPct = (Number(state.marginPct||0)/100);
  const sellHT = useCoef ? cost*coef : (marginPct<1 ? cost/(1-marginPct) : cost);

  const qty = Number(state.qty||0);
  const uCost = (qty>0) ? cost/qty : 0;
  const uSell = (qty>0) ? sellHT/qty : 0;

  // KPIs
  byId("k_mat").textContent = fmt(mat);
  // atelier hours displayed
  const atelierHours = state.lines.filter(l=>l.group==="ATELIER").reduce((s,l)=> s + (l.qty||0), 0);
  byId("k_atelier").textContent = fmt(atelier);
  byId("k_ah").textContent = Number(atelierHours||0).toLocaleString('fr-FR',{maximumFractionDigits:2});
  byId("k_ar").textContent = Number(state.atelier_rate||0).toLocaleString('fr-FR',{maximumFractionDigits:2});

  byId("k_pose").textContent = fmt(pose);
  byId("k_ovh").textContent = fmt(ovh);
  byId("k_ovhp").textContent = Number(state.overheadPct||0).toLocaleString('fr-FR',{maximumFractionDigits:1});

  byId("k_cost").textContent = fmt(cost);
  byId("k_sell_ht").textContent = fmt(sellHT);
  byId("k_margin_used").textContent = useCoef ? `Coefficient ${coef.toLocaleString('fr-FR')}` : `Marge ${Number(state.marginPct||0).toLocaleString('fr-FR')}%`;

  byId("u_cost").textContent = fmt(uCost);
  byId("u_sell_ht").textContent = fmt(uSell);

  renderLines();
  renderComposition();
}

/** =====================
 *  SAVE / LOAD / EXPORT
 *  ===================== */
byId("reset").addEventListener("click", ()=>{
  state = defaultState();
  // resync UI
  byId("family").value = state.familyKey;
  fillProductSelect();
  byId("preset").value = state.productKey;
  byId("productName").value = state.productName;

  byId("L").value = state.L;
  byId("H").value = state.H;
  byId("P").value = state.P;
  byId("qty").value = state.qty;
  byId("cncHperM2").value = state.cncHperM2;

  byId("infog_on").checked = state.infog_on;
  byId("infog_h").value = state.infog_h;
  byId("infog_rate").value = state.infog_rate;

  byId("poseMode").value = state.poseMode;
  byId("pose_h").value = state.pose_h;
  byId("pose_rate").value = state.pose_rate;
  byId("depl_forfait").value = state.deplacement_forfait;
  byId("nacelle_j").value = state.nacelle_j;
  byId("nacelle_pu").value = state.nacelle_pu;
  byId("poteaux_nb").value = state.poteaux_nb;
  byId("poteau_pu").value = state.poteau_pu;
  byId("plots_nb").value = state.plots_nb;
  byId("plot_pu").value = state.plot_pu;
  byId("scellement_h").value = state.scellement_h;

  byId("entretoise_pu").value = state.entretoise_pu;
  byId("structure_pu").value = state.structure_pu;

  byId("atelier_rate").value = state.atelier_rate;
  byId("small_markup").value = state.small_markup_pct;
  byId("overheadPct").value = state.overheadPct;
  byId("overheadFlat").value = state.overheadFlat;
  byId("marginPct").value = state.marginPct;
  byId("coef").value = state.coef;
  byId("notes").value = state.notes;

  recalc();
});

byId("save").addEventListener("click", ()=>{
  localStorage.setItem("graphicom_pricing_v2", JSON.stringify(state));
  alert("Enregistré sur cet appareil.");
});

byId("load").addEventListener("click", ()=>{
  const raw = localStorage.getItem("graphicom_pricing_v2");
  if(!raw){ alert("Aucune sauvegarde trouvée."); return; }
  state = JSON.parse(raw);

  // UI sync minimal
  byId("family").value = state.familyKey;
  fillProductSelect();
  byId("preset").value = state.productKey;
  fillPoseModes();
  byId("poseMode").value = state.poseMode;

  // bind values
  byId("productName").value = state.productName||"";
  byId("L").value = state.L||0;
  byId("H").value = state.H||0;
  byId("P").value = state.P||0;
  byId("qty").value = state.qty||0;
  byId("cncHperM2").value = state.cncHperM2||0;

  byId("infog_on").checked = !!state.infog_on;
  byId("infog_h").value = state.infog_h||0;
  byId("infog_rate").value = state.infog_rate||0;

  byId("pose_h").value = state.pose_h||0;
  byId("pose_rate").value = state.pose_rate||0;
  byId("depl_forfait").value = state.deplacement_forfait||0;
  byId("nacelle_j").value = state.nacelle_j||0;
  byId("nacelle_pu").value = state.nacelle_pu||0;
  byId("poteaux_nb").value = state.poteaux_nb||0;
  byId("poteau_pu").value = state.poteau_pu||0;
  byId("plots_nb").value = state.plots_nb||0;
  byId("plot_pu").value = state.plot_pu||0;
  byId("scellement_h").value = state.scellement_h||0;

  byId("entretoise_pu").value = state.entretoise_pu||0;
  byId("structure_pu").value = state.structure_pu||0;

  byId("atelier_rate").value = state.atelier_rate||0;
  byId("small_markup").value = state.small_markup_pct||0;
  byId("overheadPct").value = state.overheadPct||0;
  byId("overheadFlat").value = state.overheadFlat||0;
  byId("marginPct").value = state.marginPct||0;
  byId("coef").value = state.coef||"";
  byId("notes").value = state.notes||"";

  recalc();
  alert("Chargé.");
});

byId("exportCsv").addEventListener("click", ()=>{
  const rows = [];
  rows.push(["Produit", state.productName]);
  rows.push(["Famille", state.familyKey]);
  rows.push(["Préréglage", state.productKey]);
  rows.push(["L", state.L]);
  rows.push(["H", state.H]);
  rows.push(["P", state.P]);
  rows.push(["Qté", state.qty]);
  rows.push([]);

  rows.push(["Lignes", "Qté", "PU", "Total", "Groupe"]);
  state.lines.forEach(ln => rows.push([ln.label, ln.qty, ln.pu, ln.total, ln.group]));
  rows.push([]);

  const mat = state.lines.reduce((s,l)=>s + (l.total||0), 0);
  const direct = mat;
  const ovh = direct*(Number(state.overheadPct||0)/100) + Number(state.overheadFlat||0);
  const cost = direct + ovh;
  const coef = Number(state.coef||0);
  const useCoef = coef>0;
  const marginPct = (Number(state.marginPct||0)/100);
  const sellHT = useCoef ? cost*coef : (marginPct<1 ? cost/(1-marginPct) : cost);

  rows.push(["Coûts lignes", mat]);
  rows.push(["Frais structure", ovh]);
  rows.push(["Prix de revient", cost]);
  rows.push(["Vente HT", sellHT]);
  rows.push([]);

  const csv = rows.map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(";")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "graphicom_calcul_HT.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/** =====================
 *  INIT
 *  ===================== */
fillFamilySelect();
fillProductSelect();
fillPoseModes();
bindInputs();
syncProductNameDefault();
recalc();
</script>
</body>
</html>
