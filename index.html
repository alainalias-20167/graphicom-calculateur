<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Graphicom — Calculateur Prix de Revient & Vente</title>
  <style>
    :root { --b:#111; --g:#666; --bg:#f6f7f9; --w:#fff; --bd:#e5e7eb; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:var(--b);}
    header{padding:18px 16px; background:var(--w); border-bottom:1px solid var(--bd);}
    h1{margin:0; font-size:18px;}
    main{max-width:1100px; margin:0 auto; padding:16px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media(min-width:980px){ .grid{grid-template-columns: 1.1fr .9fr;} }
    .card{background:var(--w); border:1px solid var(--bd); border-radius:12px; padding:14px;}
    .row{display:grid; grid-template-columns: 1.2fr .8fr .8fr .6fr; gap:10px; align-items:end;}
    .row.head{font-weight:600; color:var(--g); font-size:12px; text-transform:uppercase;}
    label{display:block; font-size:12px; color:var(--g); margin-bottom:6px;}
    input, select, button, textarea{
      width:100%; padding:10px; border:1px solid var(--bd); border-radius:10px; background:#fff;
      font-size:14px; box-sizing:border-box;
    }
    input[type="number"]{text-align:right;}
    .btns{display:flex; gap:10px; flex-wrap:wrap;}
    button{cursor:pointer; font-weight:600;}
    button.primary{background:#111; color:#fff; border-color:#111;}
    button.ghost{background:#fff;}
    .muted{color:var(--g); font-size:12px;}
    .totals{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .kpi{border:1px solid var(--bd); border-radius:12px; padding:12px;}
    .kpi .t{color:var(--g); font-size:12px;}
    .kpi .v{font-size:18px; font-weight:700; margin-top:6px;}
    .kpi .s{font-size:12px; color:var(--g); margin-top:4px;}
    .hr{height:1px; background:var(--bd); margin:12px 0;}
    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{border-bottom:1px solid var(--bd); padding:8px; text-align:left;}
    td.num{text-align:right;}
    .pill{display:inline-block; padding:4px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; color:var(--g);}
    .miniGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .mini3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
  </style>
</head>

<body>
<header>
  <h1>Graphicom — Calculateur Prix de Revient & Prix de Vente</h1>
  <div class="muted">Appli locale (navigateur). Données enregistrées sur cet appareil.</div>
</header>

<main class="grid">
  <!-- COL 1 -->
  <section class="card">

    <div class="mini3">
      <div>
        <label>Produit (préréglage)</label>
        <select id="preset">
          <option value="">— Choisir un produit —</option>
        </select>
        <div class="muted" style="margin-top:6px;">Le choix remplit le calculateur. Tu peux ensuite ajuster.</div>
      </div>

      <div>
        <label>Largeur (mm)</label>
        <input id="Lmm" type="number" min="0" step="1" value="1000" />
      </div>

      <div>
        <label>Hauteur (mm)</label>
        <input id="Hmm" type="number" min="0" step="1" value="500" />
      </div>
    </div>

    <div class="hr"></div>

    <div class="row" style="grid-template-columns:1.2fr .8fr .8fr .6fr;">
      <div>
        <label>Nom du produit / chantier</label>
        <input id="productName" placeholder="Ex : Panneau Dibond 3mm 1200x800 + pose" />
      </div>
      <div>
        <label>Unité</label>
        <select id="unit">
          <option value="u">unité</option>
          <option value="m2">m²</option>
          <option value="ml">ml</option>
          <option value="lot">lot</option>
        </select>
      </div>
      <div>
        <label>Quantité</label>
        <input id="qty" type="number" min="0" step="0.01" value="1" />
      </div>
      <div>
        <label>TVA</label>
        <select id="vat">
          <option value="0">0%</option>
          <option value="5.5">5,5%</option>
          <option value="10">10%</option>
          <option value="20" selected>20%</option>
        </select>
      </div>
    </div>

    <div class="hr"></div>

    <div class="miniGrid">
      <div class="card" style="padding:12px; border-radius:12px;">
        <div class="pill">Règles</div>
        <div class="miniGrid" style="margin-top:10px;">
          <div>
            <label>Majoration si &lt; 1 m² (%)</label>
            <input id="smallPct" type="number" min="0" step="0.1" value="10" />
          </div>
          <div>
            <label>Seuil (m²)</label>
            <input id="smallTh" type="number" min="0" step="0.01" value="1" />
          </div>
        </div>
        <div class="muted">Appliquée sur les matières éligibles uniquement.</div>
      </div>

      <div class="card" style="padding:12px; border-radius:12px;">
        <div class="pill">Pose & options</div>
        <div class="miniGrid" style="margin-top:10px;">
          <div>
            <label>Mode de pose</label>
            <select id="poseMode">
              <option value="SANS_POSE">Sans pose</option>
              <option value="MUR_ECHELLE">Mur (échelle)</option>
              <option value="MUR_NACELLE">Mur (nacelle)</option>
              <option value="POTEAUX_PLOTS">Poteaux + plots</option>
              <option value="STRUCTURE_EXISTANTE">Sur structure existante</option>
            </select>
          </div>
          <div>
            <label>Heures de pose</label>
            <input id="poseHours" type="number" min="0" step="0.05" value="0" />
          </div>
        </div>

        <div class="miniGrid" style="margin-top:10px;">
          <div>
            <label>Déplacement (forfait)</label>
            <select id="deplacementOn">
              <option value="0">Non</option>
              <option value="1">Oui</option>
            </select>
          </div>
          <div>
            <label>Nacelle (jours)</label>
            <input id="nacelleDays" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <div class="miniGrid" style="margin-top:10px;">
          <div>
            <label>Poteaux (nb)</label>
            <input id="poteauxNb" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label>Plots béton (nb)</label>
            <input id="plotsNb" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Scellement / terrassement (h)</label>
          <input id="scellementH" type="number" min="0" step="0.05" value="0" />
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row head">
      <div>Ligne de coût</div><div>Qté</div><div>PU (€)</div><div>Total</div>
    </div>
    <div id="lines"></div>

    <div class="btns" style="margin-top:12px;">
      <button class="primary" id="addLine">+ Ajouter une ligne</button>
      <button class="ghost" id="reset">Réinitialiser</button>
      <button class="ghost" id="save">Enregistrer</button>
      <button class="ghost" id="load">Charger</button>
      <button class="ghost" id="exportCsv">Exporter CSV</button>
    </div>

    <div class="hr"></div>

    <div class="row" style="grid-template-columns:1fr 1fr 1fr;">
      <div class="card" style="padding:12px; border-radius:12px;">
        <div class="pill">Main d’œuvre (atelier)</div>
        <div class="row" style="grid-template-columns:1fr 1fr; margin-top:10px;">
          <div>
            <label>Taux atelier (€ / h)</label>
            <input id="laborRate" type="number" min="0" step="0.01" value="60" />
          </div>
          <div>
            <label>Heures atelier</label>
            <input id="laborHours" type="number" min="0" step="0.05" value="0" />
          </div>
        </div>
        <div class="muted">L’atelier est aussi alimenté par les préréglages (ex: 0,25 h/m²).</div>
      </div>

      <div class="card" style="padding:12px; border-radius:12px;">
        <div class="pill">Infographie</div>
        <div class="row" style="grid-template-columns:1fr 1fr; margin-top:10px;">
          <div>
            <label>Infographie ?</label>
            <select id="infoOn">
              <option value="0">Non</option>
              <option value="1">Oui</option>
            </select>
          </div>
          <div>
            <label>Heures</label>
            <input id="infoHours" type="number" min="0" step="0.05" value="0" />
          </div>
        </div>
        <div class="muted">Taux infographie fixé à 80€/h (ligne automatique).</div>
      </div>

      <div class="card" style="padding:12px; border-radius:12px;">
        <div class="pill">Frais fixes / structure</div>
        <div class="row" style="grid-template-columns:1fr 1fr; margin-top:10px;">
          <div>
            <label>% sur coûts directs</label>
            <input id="overheadPct" type="number" min="0" step="0.1" value="15" />
          </div>
          <div>
            <label>Forfait (€)</label>
            <input id="overheadFlat" type="number" min="0" step="0.01" value="0" />
          </div>
        </div>
        <div class="muted">Ex : atelier, énergie, admin, pertes, SAV.</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row" style="grid-template-columns:1fr 1fr;">
      <div class="card" style="padding:12px; border-radius:12px;">
        <div class="pill">Objectif de vente</div>
        <div class="row" style="grid-template-columns:1fr 1fr; margin-top:10px;">
          <div>
            <label>Marge (%)</label>
            <input id="marginPct" type="number" min="0" step="0.1" value="40" />
          </div>
          <div>
            <label>ou Coefficient</label>
            <input id="coef" type="number" min="0" step="0.01" value="" placeholder="ex : 2.10" />
          </div>
        </div>
        <div class="muted">Si coefficient renseigné, il prime sur la marge.</div>
      </div>

      <div>
        <label>Notes (client, contraintes, références matières, etc.)</label>
        <textarea id="notes" rows="6" placeholder="Ex : Dibond 3mm + vinyle quadri + lamination, pose nacelle, délais..."></textarea>
        <div class="muted" style="margin-top:8px;">
          Astuce : lignes type “Déplacement”, “Nacelle”, “Quincaillerie”, “Repas”, etc. (si besoin en plus des options).
        </div>
      </div>
    </div>

  </section>

  <!-- COL 2 -->
  <aside class="card">
    <h2 style="margin:0 0 10px 0; font-size:16px;">Résultats</h2>
    <div class="totals">
      <div class="kpi">
        <div class="t">Coûts matières & options</div>
        <div class="v" id="k_mat">0,00 €</div>
        <div class="s">Somme des lignes</div>
      </div>
      <div class="kpi">
        <div class="t">Main d’œuvre (atelier + pose + info)</div>
        <div class="v" id="k_labor">0,00 €</div>
        <div class="s" id="k_labor_detail">—</div>
      </div>
      <div class="kpi">
        <div class="t">Frais fixes / structure</div>
        <div class="v" id="k_ovh">0,00 €</div>
        <div class="s"><span id="k_ovhp">0</span>% + forfait</div>
      </div>
      <div class="kpi">
        <div class="t">Prix de revient (total)</div>
        <div class="v" id="k_cost">0,00 €</div>
        <div class="s">Pour la quantité</div>
      </div>
      <div class="kpi">
        <div class="t">Prix de vente HT</div>
        <div class="v" id="k_sell_ht">0,00 €</div>
        <div class="s"><span id="k_margin_used">marge</span></div>
      </div>
      <div class="kpi">
        <div class="t">Prix de vente TTC</div>
        <div class="v" id="k_sell_ttc">0,00 €</div>
        <div class="s">TVA <span id="k_vat">20</span>%</div>
      </div>
    </div>

    <div class="hr"></div>

    <h3 style="margin:0 0 10px 0; font-size:14px;">Détail unitaire</h3>
    <table>
      <tbody>
        <tr><td>Prix de revient / <span id="u_unit">u</span></td><td class="num" id="u_cost">0,00 €</td></tr>
        <tr><td>Vente HT / <span id="u_unit2">u</span></td><td class="num" id="u_sell_ht">0,00 €</td></tr>
        <tr><td>Vente TTC / <span id="u_unit3">u</span></td><td class="num" id="u_sell_ttc">0,00 €</td></tr>
      </tbody>
    </table>

    <div class="hr"></div>

    <div class="muted">
      <div><strong>Surface unitaire :</strong> <span id="k_su">0</span> m²</div>
      <div><strong>Surface totale :</strong> <span id="k_st">0</span> m²</div>
      <div><strong>Majoration &lt; seuil :</strong> <span id="k_small">0,00 €</span></div>
    </div>
  </aside>
</main>

<script>
  // -------------------------
  // Utils
  // -------------------------
  const byId = (id) => document.getElementById(id);
  const fmt = (n) => (Number(n || 0)).toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';
  const n2 = (v) => {
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(',', '.').trim();
    const x = Number(s);
    return Number.isFinite(x) ? x : 0;
  };
  const escapeHtml = (s) =>
    String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");

  const defaultLine = () => ({ label: "Matière / Option", qty: 1, pu: 0, meta: {eligibleSmall:false} });

  // -------------------------
  // Catalogue composants (PU modifiables ici)
  // -------------------------
  const COMPONENTS = {
    dibond_3: { label:"Dibond 3 mm", unit:"m2", pu: 0, eligibleSmall:true },
    pvc_10: { label:"PVC 10 mm", unit:"m2", pu: 0, eligibleSmall:true },
    plexi_opale: { label:"Plexi opale", unit:"m2", pu: 0, eligibleSmall:true },

    vinyle_imprime_poly: { label:"Vinyle imprimé (poly)", unit:"m2", pu: 0, eligibleSmall:true },
    vinyle_imprime_mono: { label:"Vinyle imprimé (mono)", unit:"m2", pu: 0, eligibleSmall:true },
    lamination: { label:"Lamination", unit:"m2", pu: 0, eligibleSmall:true },
    film_depoli: { label:"Film dépoli", unit:"m2", pu: 0, eligibleSmall:true },
    microperfore: { label:"Film microperforé", unit:"m2", pu: 0, eligibleSmall:true },
    retro_reflech: { label:"Film rétro-réfléchissant", unit:"m2", pu: 0, eligibleSmall:true },

    encre_uv: { label:"Encre / coût machine UV", unit:"m2", pu: 0, eligibleSmall:true },
    uv_direct: { label:"Impression UV directe", unit:"m2", pu: 0, eligibleSmall:true },

    led_ml: { label:"LED", unit:"ml", pu: 0, eligibleSmall:false },
    alim_u: { label:"Alimentation", unit:"u", pu: 0, eligibleSmall:false },
    cablage_forfait: { label:"Câblage", unit:"forfait", pu: 0, eligibleSmall:false },

    calage_fichier: { label:"Calage / préparation fichier", unit:"forfait", pu: 0, eligibleSmall:false },
    deplacement_forfait: { label:"Déplacement", unit:"forfait", pu: 0, eligibleSmall:false },
    nacelle_j: { label:"Nacelle", unit:"jour", pu: 0, eligibleSmall:false },
    poteaux_nb: { label:"Poteaux", unit:"u", pu: 0, eligibleSmall:false },
    plots_nb: { label:"Plots béton", unit:"u", pu: 0, eligibleSmall:false },
  };

  // -------------------------
  // Produits (presets)
  // atelier_h_per_m2 validé : panneau 0,25 / vitrophanie 0,25 / signalétique 0,30 ...
  // -------------------------
  const PRODUCTS = {
    panneau_dibond_std: {
      label: "Panneau Dibond – Standard",
      atelier_h_per_m2: 0.25,
      lines: (ctx) => ([
        makeLineFromComponent("dibond_3", ctx.surfaceTot),
        makeLineFromComponent("vinyle_imprime_poly", ctx.surfaceTot),
        makeLineFromComponent("lamination", 0), // option
        makeLineFromComponent("calage_fichier", 1),
        // atelier alimenté dans le bloc atelier (heures)
      ])
    },
    vitrophanie: {
      label: "Vitrophanie",
      atelier_h_per_m2: 0.25,
      lines: (ctx) => ([
        makeLineFromComponent("vinyle_imprime_poly", ctx.surfaceTot),
        makeLineFromComponent("film_depoli", 0),
        makeLineFromComponent("microperfore", 0),
        makeLineFromComponent("lamination", 0),
        makeLineFromComponent("calage_fichier", 1),
      ])
    },
    signaletique: {
      label: "Signalétique",
      atelier_h_per_m2: 0.30,
      lines: (ctx) => ([
        makeLineFromComponent("dibond_3", ctx.surfaceTot),
        makeLineFromComponent("vinyle_imprime_poly", ctx.surfaceTot),
        makeLineFromComponent("retro_reflech", 0),
        makeLineFromComponent("lamination", 0),
        makeLineFromComponent("calage_fichier", 1),
      ])
    },
    impression_uv: {
      label: "Impression UV (m²)",
      atelier_h_per_m2: 0.25,
      lines: (ctx) => ([
        makeLineFromComponent("uv_direct", ctx.surfaceTot),
        makeLineFromComponent("encre_uv", ctx.surfaceTot),
        makeLineFromComponent("calage_fichier", 1),
      ])
    },
    plaque_pros: {
      label: "Plaque pro (m²)",
      atelier_h_per_m2: 0.25,
      lines: (ctx) => ([
        makeLineFromComponent("plexi_opale", ctx.surfaceTot),
        makeLineFromComponent("uv_direct", ctx.surfaceTot),
        makeLineFromComponent("encre_uv", ctx.surfaceTot),
        makeLineFromComponent("calage_fichier", 1),
      ])
    }
  };

  function makeLineFromComponent(key, qty){
    const c = COMPONENTS[key];
    if(!c) return defaultLine();
    return {
      label: c.label,
      qty: Number(qty || 0),
      pu: Number(c.pu || 0),
      meta: { eligibleSmall: !!c.eligibleSmall, compKey: key }
    };
  }

  // -------------------------
  // State
  // -------------------------
  let state = {
    preset: "",
    productName: "",
    unit: "u",
    qty: 1,
    vat: 20,
    Lmm: 1000,
    Hmm: 500,

    smallTh: 1.0,
    smallPct: 10.0,

    lines: [ defaultLine() ],

    laborRate: 60,     // atelier
    laborHours: 0,     // atelier

    poseHours: 0,
    poseRate: 70,

    infoOn: 0,
    infoHours: 0,
    infoRate: 80,

    overheadPct: 15,
    overheadFlat: 0,
    marginPct: 40,
    coef: "",
    notes: "",

    poseMode: "SANS_POSE",
    deplacementOn: 0,
    nacelleDays: 0,
    poteauxNb: 0,
    plotsNb: 0,
    scellementH: 0,

    // PU pose/options (éditables ici ou via lignes manuelles)
    pu_deplacement: 0,
    pu_nacelle: 0,
    pu_poteau: 0,
    pu_plot: 0,
  };

  // -------------------------
  // UI rendering
  // -------------------------
  function renderLines(){
    const container = byId('lines');
    container.innerHTML = "";
    state.lines.forEach((ln, i) => {
      const row = document.createElement('div');
      row.className = "row";
      row.style.gridTemplateColumns = "1.2fr .8fr .8fr .6fr";
      row.innerHTML = `
        <div>
          <label>Libellé</label>
          <input data-k="label" data-i="${i}" value="${escapeHtml(ln.label)}" />
          <div class="btns" style="margin-top:6px;">
            <button class="ghost" type="button" data-act="dup" data-i="${i}">Dupliquer</button>
            <button class="ghost" type="button" data-act="del" data-i="${i}">Supprimer</button>
          </div>
        </div>
        <div>
          <label>Qté</label>
          <input data-k="qty" data-i="${i}" type="number" min="0" step="0.01" value="${ln.qty}" />
        </div>
        <div>
          <label>PU (€)</label>
          <input data-k="pu" data-i="${i}" type="number" min="0" step="0.01" value="${ln.pu}" />
        </div>
        <div>
          <label>Total</label>
          <input value="${fmt(n2(ln.qty) * n2(ln.pu))}" disabled />
        </div>
      `;
      container.appendChild(row);
    });

    container.querySelectorAll('input[data-k]').forEach(inp=>{
      inp.addEventListener('input', (e)=>{
        const i = Number(e.target.dataset.i);
        const k = e.target.dataset.k;
        state.lines[i][k] = (k === "label") ? e.target.value : n2(e.target.value);
        recalc();
        renderLines();
      });
    });

    container.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const i = Number(e.target.dataset.i);
        const act = e.target.dataset.act;
        if(act === "del"){
          state.lines.splice(i,1);
          if(state.lines.length === 0) state.lines.push(defaultLine());
        }
        if(act === "dup"){
          state.lines.splice(i+1, 0, JSON.parse(JSON.stringify(state.lines[i])));
        }
        renderLines();
        recalc();
      });
    });
  }

  function fillPresetSelect(){
    const sel = byId("preset");
    sel.innerHTML = `<option value="">— Choisir un produit —</option>`;
    Object.entries(PRODUCTS).forEach(([k,v])=>{
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = v.label;
      sel.appendChild(opt);
    });
  }

  function applyPreset(key){
    const p = PRODUCTS[key];
    if(!p) return;

    state.preset = key;

    // Calcul surfaces
    const L = n2(state.Lmm)/1000;
    const H = n2(state.Hmm)/1000;
    const qty = n2(state.qty) || 1;
    const surfaceUnit = L * H;
    const surfaceTot = surfaceUnit * qty;

    // Remplit les lignes matières/options du produit
    state.lines = p.lines({ surfaceUnit, surfaceTot, qty }).filter(ln => (n2(ln.qty) !== 0));

    if(state.lines.length === 0) state.lines = [defaultLine()];

    // Atelier : preset => heures = surfaceTot * atelier_h_per_m2
    state.laborHours = surfaceTot * (p.atelier_h_per_m2 || 0);

    // Nom produit si vide
    if(!state.productName) state.productName = p.label;

    bindTopFields(); // remet les valeurs visibles
    renderLines();
    recalc();
  }

  function bindTopFields(){
    const map = [
      ["productName","productName"],
      ["unit","unit"],
      ["qty","qty"],
      ["vat","vat"],
      ["Lmm","Lmm"],
      ["Hmm","Hmm"],
      ["smallPct","smallPct"],
      ["smallTh","smallTh"],

      ["laborRate","laborRate"],
      ["laborHours","laborHours"],

      ["poseMode","poseMode"],
      ["poseHours","poseHours"],
      ["deplacementOn","deplacementOn"],
      ["nacelleDays","nacelleDays"],
      ["poteauxNb","poteauxNb"],
      ["plotsNb","plotsNb"],
      ["scellementH","scellementH"],

      ["infoOn","infoOn"],
      ["infoHours","infoHours"],

      ["overheadPct","overheadPct"],
      ["overheadFlat","overheadFlat"],
      ["marginPct","marginPct"],
      ["coef","coef"],
      ["notes","notes"],
    ];

    map.forEach(([id,key])=>{
      const el = byId(id);
      if(!el) return;
      el.value = state[key] ?? "";
      const onAny = () => {
        state[key] = (el.type === "number" || ["vat","overheadPct","marginPct"].includes(id)) ? n2(el.value) : el.value;
        recalc();
      };
      el.addEventListener('input', onAny);
      el.addEventListener('change', () => {
        if(id === "unit") {
          byId("u_unit").textContent = state.unit;
          byId("u_unit2").textContent = state.unit;
          byId("u_unit3").textContent = state.unit;
        }
        if(id === "preset"){
          if(el.value) applyPreset(el.value);
        }
        recalc();
      });
    });

    // preset
    byId("preset").value = state.preset || "";
    byId("u_unit").textContent = state.unit;
    byId("u_unit2").textContent = state.unit;
    byId("u_unit3").textContent = state.unit;
  }

  // -------------------------
  // Calcul
  // -------------------------
  function recalc(){
    const L = n2(state.Lmm)/1000;
    const H = n2(state.Hmm)/1000;
    const qty = n2(state.qty) || 1;
    const surfaceUnit = L * H;
    const surfaceTot = surfaceUnit * qty;

    // 1) Matières / options (lignes)
    const smallTh = n2(state.smallTh);
    const smallPct = n2(state.smallPct)/100;

    let mat = 0;
    let smallMarkup = 0;

    for(const ln of state.lines){
      const lineBase = n2(ln.qty) * n2(ln.pu);
      if(surfaceUnit > 0 && surfaceUnit < smallTh && ln.meta && ln.meta.eligibleSmall){
        const extra = lineBase * smallPct;
        mat += (lineBase + extra);
        smallMarkup += extra;
      } else {
        mat += lineBase;
      }
    }

    // 2) Main d’œuvre : atelier + pose + infographie (en HT)
    const atelier = n2(state.laborRate) * n2(state.laborHours);

    // Pose : heures * 70 + options (si activées)
    const pose = n2(state.poseHours) * 70;

    let poseOptions = 0;
    // Ici, on passe par des lignes automatiques (simples)
    // Tu peux aussi les mettre manuellement en lignes si tu préfères.
    // (On garde automatique pour la logique métier)
    if(String(state.deplacementOn) === "1") poseOptions += 0; // PU déplacement à renseigner si tu veux
    poseOptions += 0; // nacelle/poteaux/plots non chiffrés ici (on les mettra quand tu me donnes les PU)

    const info = (String(state.infoOn) === "1") ? (80 * n2(state.infoHours)) : 0;

    const labor = atelier + pose + poseOptions + info;

    // 3) Frais fixes / structure
    const direct = mat + labor;
    const ovh = (direct * (n2(state.overheadPct)/100)) + n2(state.overheadFlat);
    const cost = direct + ovh;

    // 4) Vente
    const coef = n2(state.coef);
    const useCoef = coef > 0;
    const marginPct = n2(state.marginPct)/100;
    const sellHT = useCoef ? (cost * coef) : (marginPct < 1 ? cost / (1 - marginPct) : cost);

    const vatRate = n2(state.vat)/100;
    const sellTTC = sellHT * (1 + vatRate);

    // Unitaire
    const uCost = cost / qty;
    const uSellHT = sellHT / qty;
    const uSellTTC = sellTTC / qty;

    // UI
    byId("k_mat").textContent = fmt(mat);
    byId("k_labor").textContent = fmt(labor);
    byId("k_labor_detail").textContent =
      `atelier ${n2(state.laborHours).toLocaleString('fr-FR',{maximumFractionDigits:2})}h × ${n2(state.laborRate).toLocaleString('fr-FR',{maximumFractionDigits:2})}€/h`
      + ` + pose ${n2(state.poseHours).toLocaleString('fr-FR',{maximumFractionDigits:2})}h × 70€/h`
      + (String(state.infoOn)==="1" ? ` + info ${n2(state.infoHours).toLocaleString('fr-FR',{maximumFractionDigits:2})}h × 80€/h` : "");

    byId("k_ovh").textContent = fmt(ovh);
    byId("k_ovhp").textContent = n2(state.overheadPct).toLocaleString('fr-FR',{maximumFractionDigits:1});
    byId("k_cost").textContent = fmt(cost);

    byId("k_sell_ht").textContent = fmt(sellHT);
    byId("k_sell_ttc").textContent = fmt(sellTTC);
    byId("k_vat").textContent = n2(state.vat).toLocaleString('fr-FR',{maximumFractionDigits:1});
    byId("k_margin_used").textContent = useCoef ? `Coefficient ${coef.toLocaleString('fr-FR')}` : `Marge ${n2(state.marginPct).toLocaleString('fr-FR')}%`;

    byId("u_cost").textContent = fmt(uCost);
    byId("u_sell_ht").textContent = fmt(uSellHT);
    byId("u_sell_ttc").textContent = fmt(uSellTTC);

    byId("k_su").textContent = surfaceUnit.toLocaleString('fr-FR',{maximumFractionDigits:4});
    byId("k_st").textContent = surfaceTot.toLocaleString('fr-FR',{maximumFractionDigits:4});
    byId("k_small").textContent = fmt(smallMarkup);
  }

  // -------------------------
  // Buttons
  // -------------------------
  byId("addLine").addEventListener('click', ()=>{
    state.lines.push(defaultLine());
    renderLines();
    recalc();
  });

  byId("reset").addEventListener('click', ()=>{
    state = {
      ...state,
      preset:"",
      productName:"",
      unit:"u",
      qty:1,
      vat:20,
      Lmm:1000,
      Hmm:500,
      smallTh:1,
      smallPct:10,
      lines:[defaultLine()],
      laborRate:60,
      laborHours:0,
      poseMode:"SANS_POSE",
      poseHours:0,
      deplacementOn:0,
      nacelleDays:0,
      poteauxNb:0,
      plotsNb:0,
      scellementH:0,
      infoOn:0,
      infoHours:0,
      overheadPct:15,
      overheadFlat:0,
      marginPct:40,
      coef:"",
      notes:""
    };
    fillPresetSelect();
    bindTopFields();
    renderLines();
    recalc();
  });

  byId("save").addEventListener('click', ()=>{
    const key = "graphicom_pricing_v2";
    localStorage.setItem(key, JSON.stringify(state));
    alert("Enregistré sur cet appareil.");
  });

  byId("load").addEventListener('click', ()=>{
    const key = "graphicom_pricing_v2";
    const raw = localStorage.getItem(key);
    if(!raw){ alert("Aucune sauvegarde trouvée."); return; }
    state = JSON.parse(raw);
    fillPresetSelect();
    bindTopFields();
    renderLines();
    recalc();
    alert("Chargé.");
  });

  byId("exportCsv").addEventListener('click', ()=>{
    const rows = [];
    rows.push(["Produit", state.productName]);
    rows.push(["Preset", state.preset]);
    rows.push(["L (mm)", state.Lmm]);
    rows.push(["H (mm)", state.Hmm]);
    rows.push(["Unité", state.unit]);
    rows.push(["Quantité", state.qty]);
    rows.push(["TVA", state.vat + "%"]);
    rows.push([]);
    rows.push(["Lignes", "Qté", "PU", "Total"]);
    state.lines.forEach(ln => rows.push([ln.label, ln.qty, ln.pu, (n2(ln.qty)*n2(ln.pu))]));
    rows.push([]);
    rows.push(["Heures atelier", state.laborHours]);
    rows.push(["Taux atelier", state.laborRate]);
    rows.push(["Heures pose", state.poseHours]);
    rows.push(["Infographie", state.infoOn]);
    rows.push(["Heures info", state.infoHours]);
    rows.push(["Notes", state.notes]);

    const csv = rows.map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(";")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "graphicom_calcul.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Init
  fillPresetSelect();
  bindTopFields();
  renderLines();
  recalc();
</script>

</body>
</html>
